# モバイル・タブレット接続問題の診断と解決ガイド

## 🔍 問題の概要

PCでルームを作成しても、スマホやタブレットから以下の問題が発生する：
- ルームIDを入力しても参加できない
- ルーム作成ができない
- 接続エラーが表示される

## 📱 診断ツールの使用方法

### 1. 診断ツールへのアクセス
サイト下部のフッターにある「🔍 接続診断」リンクをクリック

または直接アクセス:
```
https://your-site.com/diagnosis.html
```

### 2. 診断内容
診断ツールは以下を自動チェック：
- ✅ デバイス情報（OS、ブラウザ、画面サイズ）
- ✅ オンライン状態
- ✅ Firebase接続状態
- ✅ ルーム作成テスト
- ✅ ルーム参加テスト

## 🔧 よくある原因と解決策

### 1. Firebaseセキュリティルールの問題

**症状:**
- ルーム作成時に「Permission denied」エラー
- データが保存されない

**解決策:**
Firebase Console → Realtime Database → ルールタブ

```json
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
```

⚠️ **注意**: 本番環境では適切なセキュリティルールを設定してください

### 2. 承認済みドメインの未設定

**症状:**
- 「Auth domain not whitelisted」エラー
- 認証エラー

**解決策:**
Firebase Console → Authentication → Settings → 承認済みドメイン

以下を追加:
- `localhost`
- `127.0.0.1`
- `あなたのドメイン.com`
- `your-app.web.app` (Firebase Hosting使用時)

### 3. ブラウザのキャッシュ問題

**症状:**
- 古いコードが実行される
- 最新の機能が動作しない

**解決策:**

**iOS Safari:**
1. 設定 → Safari → 履歴とWebサイトデータを消去
2. または: Safariで長押し → リロード

**Android Chrome:**
1. 設定 → プライバシー → 閲覧履歴データの削除
2. または: Chromeメニュー → 設定 → サイトの設定 → すべてのサイト → データを消去

**スーパーリロード:**
- PC: `Ctrl + Shift + R` (Win) / `Cmd + Shift + R` (Mac)
- モバイル: 通常のリロードではキャッシュクリアされないため、上記手順が必要

### 4. プライベートモード/シークレットモード

**症状:**
- データが保存されない
- ルームに参加できない

**解決策:**
- プライベートモード/シークレットモードを無効化
- 通常のブラウザタブで開く

理由: プライベートモードではCookieとローカルストレージが制限される

### 5. VPN・プロキシの干渉

**症状:**
- Firebase接続エラー
- タイムアウトエラー

**解決策:**
- VPNを一時的に無効化
- プロキシ設定を確認
- 別のネットワーク（Wi-Fi/モバイルデータ）で試す

### 6. モバイルブラウザの互換性

**推奨ブラウザ:**
- ✅ iOS: Safari 14+
- ✅ Android: Chrome 90+
- ✅ Android: Firefox 90+

**非推奨:**
- ❌ 古いバージョンのブラウザ
- ❌ 一部のサードパーティブラウザ

### 7. ネットワーク制限

**症状:**
- 特定のWi-Fiでのみ接続できない
- 企業/学校のネットワークで動作しない

**原因:**
- ファイアウォールがFirebaseをブロック
- ポート443（HTTPS）が制限されている

**解決策:**
- モバイルデータ（4G/5G）に切り替えて試す
- 別のWi-Fiネットワークを使用
- ネットワーク管理者に以下のドメインの許可を依頼:
  - `*.firebaseio.com`
  - `*.googleapis.com`
  - `*.firebaseapp.com`

## 📊 診断ツールの詳細

### テスト項目

#### 1. デバイス情報
- OS・デバイスタイプの検出
- ブラウザ情報
- 画面サイズ
- オンライン状態

#### 2. Firebase接続テスト
- `.info/connected`での接続確認
- 書き込みテスト
- 読み取りテスト
- クリーンアップ

#### 3. ルーム作成テスト
- ランダムIDでテストルーム作成
- データ書き込み確認
- データ読み取り確認
- 自動削除

#### 4. ルーム参加テスト
- テストルーム作成
- プレイヤー追加
- 参加確認
- 自動削除

### ログの見方

```
[時刻] ✅ Firebase接続成功
[時刻] ✅ 書き込みテスト成功
[時刻] ✅ ルーム作成成功
[時刻] ✅ ルーム読み取り成功
```

すべて「✅」であれば正常に動作しています。

「❌」がある場合は、該当するセクションの解決策を試してください。

## 🚀 トラブルシューティング手順

### ステップ1: 診断ツールを実行
1. `diagnosis.html`を開く
2. 自動テストの結果を確認
3. エラーがあれば詳細ログを確認

### ステップ2: 基本的な対処
1. ブラウザのキャッシュをクリア
2. ページをスーパーリロード
3. プライベートモードを無効化
4. VPNを無効化

### ステップ3: Firebase設定確認
1. セキュリティルールが正しいか確認
2. 承認済みドメインに追加されているか確認
3. APIキーが有効か確認

### ステップ4: ネットワーク確認
1. 別のWi-Fiで試す
2. モバイルデータで試す
3. 別のデバイスで試す

### ステップ5: サポートに連絡
上記すべて試しても解決しない場合:
1. 診断ツールのログをスクリーンショット
2. お問い合わせフォームから送信
3. 以下の情報を含める:
   - デバイス・OS・ブラウザ
   - エラーメッセージ
   - 診断ツールの結果

## 💡 予防策

### 開発者向け
1. **エラーハンドリングの強化**
   - すべての非同期処理にtry-catchを実装
   - ユーザーフレンドリーなエラーメッセージ
   - 診断ツールへの誘導

2. **ログ出力の充実**
   - `console.log`で処理の進行を記録
   - エラー時は詳細情報を出力
   - Firebaseの接続状態を監視

3. **モバイル対応**
   - レスポンシブデザイン
   - タッチイベントの最適化
   - ビューポート設定

4. **テスト**
   - 複数のデバイスでテスト
   - 異なるネットワーク環境でテスト
   - ブラウザ互換性テスト

### ユーザー向け
1. **推奨環境**
   - 最新バージョンのブラウザ
   - 安定したネットワーク接続
   - Cookie・JavaScriptを有効化

2. **定期的なメンテナンス**
   - ブラウザのキャッシュクリア
   - アプリの更新（モバイルアプリの場合）
   - OSの更新

## 📝 まとめ

モバイル・タブレットでの接続問題の多くは、以下のいずれかが原因です：

1. **Firebase設定** (50%)
   - セキュリティルール
   - 承認済みドメイン

2. **ブラウザ・キャッシュ** (30%)
   - 古いコード
   - ストレージ制限

3. **ネットワーク** (15%)
   - ファイアウォール
   - VPN干渉

4. **ブラウザ互換性** (5%)
   - 古いバージョン
   - 非対応ブラウザ

診断ツール (`diagnosis.html`) を使用することで、問題の原因を素早く特定できます。

---

**作成日**: 2026年2月16日  
**対象**: すべてのゲームモード（ワードウルフ、デマーシア、ヴォイド）  
**診断ツール**: `diagnosis.html`
