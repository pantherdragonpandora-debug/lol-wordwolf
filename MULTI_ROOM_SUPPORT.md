# 🎮 マルチルーム対応とルームID衝突防止ガイド

## 📋 概要

このアプリケーションは、**複数のルームを同時に運用可能**です。多くのユーザーが同時に異なるルームを立てて遊ぶことができます。

## ✅ 実装されている機能

### 1. ルームIDの重複防止

#### 問題（修正前）
```javascript
// 単純なランダム生成
function generateRoomId() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}
```
- 6桁の数字（100000〜999999）= 900,000通り
- 重複の可能性あり
- ワードウルフとデマーシアで同じIDが生成される可能性

#### 解決策（修正後）
```javascript
async function generateRoomId() {
  // 1. ランダムなIDを生成
  // 2. ワードウルフルームをチェック (rooms/)
  // 3. デマーシアルームをチェック (demacia_rooms/)
  // 4. 両方とも存在しない場合のみ使用
  // 5. 重複した場合は再生成（最大10回試行）
  // 6. それでも重複する場合はタイムスタンプベースのID使用
}
```

### 2. データベース構造

```
Firebase Realtime Database
├── rooms/                     # ワードウルフ用
│   ├── 123456/               # ルームID
│   │   ├── host: "Player1"
│   │   ├── settings:
│   │   │   ├── gameType: "lol"
│   │   │   └── ...
│   │   └── players: {...}
│   ├── 234567/               # 別のルーム
│   └── 345678/               # さらに別のルーム
│
└── demacia_rooms/            # デマーシア用
    ├── 456789/               # ルームID
    │   ├── host: "Player2"
    │   ├── settings:
    │   │   ├── gameType: "valorant"
    │   │   └── ...
    │   └── players: {...}
    └── 567890/               # 別のルーム
```

### 3. ルームIDの衝突防止フロー

```
[ルーム作成開始]
       ↓
[ランダムID生成: 123456]
       ↓
[rooms/123456 をチェック]
       ↓
    存在する？
    ├─ Yes → [再生成]
    └─ No  → ↓
       ↓
[demacia_rooms/123456 をチェック]
       ↓
    存在する？
    ├─ Yes → [再生成]
    └─ No  → ↓
       ↓
[✅ 使用可能]
       ↓
[ルーム作成]
```

## 🎯 複数ルームの同時運用

### シナリオ1: 異なるゲームモード
```
ユーザーA: ワードウルフ + LOL
  → rooms/123456

ユーザーB: デマーシア + VALORANT
  → demacia_rooms/234567

結果: ✅ 両方とも問題なく動作
```

### シナリオ2: 同じゲームモード、異なるゲームタイプ
```
ユーザーA: ワードウルフ + LOL
  → rooms/123456

ユーザーB: ワードウルフ + VALORANT
  → rooms/234567

結果: ✅ 両方とも問題なく動作
```

### シナリオ3: 完全に同じ設定
```
ユーザーA: ワードウルフ + LOL
  → rooms/123456

ユーザーB: ワードウルフ + LOL
  → rooms/234567

結果: ✅ 両方とも問題なく動作
       (ルームIDが異なるため独立)
```

### シナリオ4: 大量の同時ルーム
```
100人のユーザーが同時にルームを作成
  → rooms/123456
  → rooms/234567
  → rooms/345678
  → ... (100個のルーム)

結果: ✅ すべて独立して動作
       (Firebaseの制限内であれば問題なし)
```

## 📊 ルームIDの衝突確率

### 理論上の衝突確率

**条件:**
- 6桁の数字（100000〜999999）
- 合計: 900,000通り

**既存ルームが1個の場合:**
- 衝突確率: 1 / 900,000 = 0.00011%

**既存ルームが100個の場合:**
- 衝突確率: 100 / 900,000 = 0.011%

**既存ルームが1,000個の場合:**
- 衝突確率: 1,000 / 900,000 = 0.11%

**既存ルームが10,000個の場合:**
- 衝突確率: 10,000 / 900,000 = 1.1%

### 実際の動作

修正後のシステムでは：
- ✅ 衝突時は自動的に再生成（最大10回）
- ✅ 10回試行してもダメな場合はタイムスタンプベース
- ✅ 実質的に衝突はほぼ発生しない

## 🔢 ルームID生成の詳細

### 生成アルゴリズム

```javascript
async function generateRoomId() {
  const maxAttempts = 10;
  
  for (let i = 0; i < maxAttempts; i++) {
    // 1. ランダムID生成
    const roomId = Math.floor(100000 + Math.random() * 900000).toString();
    
    // 2. 重複チェック
    const [wordwolfSnapshot, demaciaSnapshot] = await Promise.all([
      firebase.database().ref(`rooms/${roomId}`).once('value'),
      firebase.database().ref(`demacia_rooms/${roomId}`).once('value')
    ]);
    
    // 3. 使用可能か判定
    if (!wordwolfSnapshot.exists() && !demaciaSnapshot.exists()) {
      return roomId; // ✅ 使用可能
    }
    
    // 4. 重複した場合は次の試行へ
  }
  
  // 5. フォールバック: タイムスタンプベース
  return (Date.now() % 1000000).toString().padStart(6, '0');
}
```

### タイムスタンプベースID

**10回試行して全て衝突した場合:**
```javascript
Date.now() = 1707900000000 (例)
1707900000000 % 1000000 = 000000
padStart(6, '0') = "000000"
```

- ミリ秒単位のタイムスタンプを使用
- 同時生成でも異なるIDになる可能性が高い

## 🚀 パフォーマンスへの影響

### ルーム作成時間

**通常（衝突なし）:**
```
ランダムID生成: 1ms
重複チェック: 50-100ms (Firebase API)
合計: 約100ms
```

**衝突時（1回再試行）:**
```
1回目: 100ms (衝突)
2回目: 100ms (成功)
合計: 約200ms
```

**最悪ケース（10回試行）:**
```
10回試行: 1000ms
タイムスタンプ生成: 1ms
合計: 約1秒
```

### ユーザー体験への影響

- ✅ 通常は即座にルーム作成（0.1秒）
- ✅ 衝突時も気づかないレベル（0.2秒）
- ✅ 最悪ケースでも許容範囲（1秒）

## 📈 スケーラビリティ

### 同時接続数の上限

**Firebase Realtime Database の制限:**
- 無料プラン: 100同時接続
- Flameプラン: 200,000同時接続
- Blazeプラン: 無制限（従量課金）

**このアプリの想定:**
- 1ルーム = 3〜10人
- 100同時接続 = 10〜30ルーム程度

### ルーム数の上限

**理論上:**
- 900,000個まで（6桁の数字の範囲）

**実用上:**
- 数千〜数万ルームまで問題なし
- Firebaseのストレージ制限に依存

## 🔒 セキュリティ考慮事項

### ルームID推測攻撃

**リスク:**
- 6桁の数字 = 総当たり可能

**対策（将来的に実装推奨）:**
1. ルームにパスワード設定機能
2. ホストによる参加承認制
3. 8桁以上の英数字ID
4. 招待制（URLでのみ参加可能）

### 現状の仕様

- ✅ ルームIDを知っていれば誰でも参加可能
- ✅ 友達同士でカジュアルに遊ぶには十分
- ⚠️ 公開対戦には向いていない

## 🧪 テスト方法

### テスト1: 重複チェックの動作確認

```javascript
// ブラウザコンソールで実行
diagnosisFirebase().then(() => {
  console.log('現在のルーム数を確認してください');
});

// ルーム作成時のログを確認
// 「✅ ユニークなルームID生成: XXXXXX」が表示されることを確認
```

### テスト2: 複数ルームの同時作成

```
1. ブラウザAでワードウルフ+LOLのルームを作成
2. ブラウザBでデマーシア+VALORANTのルームを作成
3. ブラウザCでワードウルフ+TFTのルームを作成

結果: すべて独立したルームIDが生成される
```

### テスト3: 衝突時の再生成

```javascript
// 手動で衝突をシミュレート（開発者用）
// Firebase Consoleで以下のルームを事前作成:
rooms/123456
demacia_rooms/123456

// その後、ルーム作成を実行
// 123456以外のIDが生成されることを確認
```

## 📞 トラブルシューティング

### Q: ルーム作成に時間がかかる

**原因:**
- ルームID衝突が頻発している
- Firebaseの応答が遅い

**対策:**
1. ブラウザのコンソールで衝突回数を確認
2. 既存ルームが多すぎる場合は古いルームを削除
3. インターネット接続を確認

### Q: 「ルームが存在しません」エラー

**原因:**
- ルームIDの入力ミス
- ルームが既に削除された
- ゲームモード/タイプの不一致

**対策:**
1. ルームIDを再確認（6桁）
2. ルーム作成者に再度URLを送ってもらう
3. コンソールで `checkRoom("123456")` を実行

## 🎉 まとめ

### ✅ 可能なこと

- ✅ 複数のルームを同時に立てられる
- ✅ 数千人が同時に遊べる（Firebaseプランに依存）
- ✅ ルームIDの衝突は自動で回避
- ✅ ワードウルフとデマーシアは完全に独立

### ⚠️ 制限事項

- ⚠️ ルームIDは6桁の数字（900,000通り）
- ⚠️ Firebase無料プランは100同時接続
- ⚠️ ルームIDを知っていれば誰でも参加可能

### 🚀 将来の改善案

- 🔮 8桁の英数字ID（約3兆通り）
- 🔮 ルームパスワード機能
- 🔮 ホストによる参加承認
- 🔮 ルームの自動削除（24時間後）
- 🔮 ルーム一覧表示機能

---

**色んな人が同時にルームを立てて遊べます！安心してご利用ください！** 🎮✨
