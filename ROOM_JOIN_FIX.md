# 🔧 ルーム参加エラーの修正ガイド

## 問題: 「ルームが存在しません」エラー

友達がルームIDを入れて参加しようとしたとき、「ルームが存在しません」というエラーが表示される。

## 🔍 原因

以下のいずれかの原因が考えられます：

### 1. Firebaseセキュリティルールの問題
最も一般的な原因です。書き込み権限が正しく設定されていない可能性があります。

### 2. ルーム作成時のエラー
ルームが正常に作成されていない可能性があります。

### 3. ゲームタイプの不一致
ワードウルフとデマーシアで異なるデータベースパスを使用しているため、正しく検索できていない可能性があります。

## ✅ 修正内容

### 1. ルーム参加ロジックの改善
`js/main.js`の`joinRoom()`関数を修正し、以下を実装：
- ✅ ワードウルフルーム（`rooms/`）とデマーシアルーム（`demacia_rooms/`）の両方をチェック
- ✅ 詳細なログ出力
- ✅ より明確なエラーメッセージ

### 2. ルーム作成の確認機能
`js/game.js`と`js/demacia-game.js`に以下を追加：
- ✅ ルーム作成直後に実際にFirebaseに保存されたか確認
- ✅ 詳細なログ出力

## 🚀 トラブルシューティング手順

### ステップ1: ブラウザのコンソールを確認

#### ルーム作成者側
1. F12キーでデベロッパーツールを開く
2. Consoleタブを選択
3. ルームを作成
4. 以下のログを確認：

**正常な場合:**
```
🔧 デマーシアルーム作成開始
📝 作成するルームデータ: {...}
✅ デマーシアルーム作成成功: XXXXXX
🔍 作成確認: 成功
🔍 確認データ: {...}
```

**異常な場合:**
```
❌ ルーム作成エラー: Error: PERMISSION_DENIED
⚠️ ルームが作成されていません！Firebaseルールを確認してください
```

#### ルーム参加者側
1. F12キーでデベロッパーツールを開く
2. Consoleタブを選択
3. ルームIDを入力して参加
4. 以下のログを確認：

**正常な場合:**
```
🔍 ルーム参加試行: XXXXXX プレイヤー: 名前
ワードウルフルーム存在: false
デマーシアルーム存在: true
✅ デマーシアルームに参加
```

**異常な場合:**
```
🔍 ルーム参加試行: XXXXXX プレイヤー: 名前
ワードウルフルーム存在: false
デマーシアルーム存在: false
❌ ルームが見つかりません: XXXXXX
```

### ステップ2: Firebaseセキュリティルールを確認

#### 現在必要なルール
```json
{
  "rules": {
    "rooms": {
      ".read": true,
      ".write": true
    },
    "demacia_rooms": {
      ".read": true,
      ".write": true
    }
  }
}
```

#### 確認手順
1. [Firebase Console](https://console.firebase.google.com/) にアクセス
2. プロジェクト `lol-word-wolf` を選択
3. 左メニューから「Realtime Database」を選択
4. 「ルール」タブをクリック
5. 上記のルールが設定されているか確認

#### ルールの更新方法
1. 上記のJSON全体をコピー
2. Firebaseコンソールのルールエディタに貼り付け
3. 「公開」ボタンをクリック
4. 警告が表示されたら「公開」を再度クリック

### ステップ3: ルームIDの確認

#### ルーム作成者
1. 待機室画面に表示されるルームIDをコピー
2. または「URLをコピー」ボタンでURLごとコピー

#### ルーム参加者
1. ルームIDは **6桁の数字** （例: 123456）
2. 大文字・小文字は区別されない
3. スペースや特殊文字は含まない

### ステップ4: ネットワーク接続の確認

#### Firebaseの接続状態
画面右上に接続状態が表示されます：
- ✅ 「接続中」: 正常
- ❌ 「切断」: インターネット接続を確認

#### 接続状態の確認方法
```javascript
// ブラウザコンソールで実行
firebase.database().ref('.info/connected').on('value', (snap) => {
  console.log('Firebase接続:', snap.val() ? '✅ 接続中' : '❌ 切断');
});
```

## 🆘 よくある問題と解決策

### 問題1: PERMISSION_DENIED エラー

**症状:**
```
Error: PERMISSION_DENIED: Permission denied
```

**原因:**
Firebaseセキュリティルールで書き込み権限が許可されていない

**解決策:**
上記「ステップ2: Firebaseセキュリティルールを確認」を実行

### 問題2: ルームは作成されるが参加できない

**症状:**
- ルーム作成者は待機室に入れる
- 参加者は「ルームが存在しません」エラー

**原因:**
- デマーシアゲーム用のルール（`demacia_rooms`）が未設定
- ワードウルフとデマーシアで異なるパスを使用

**解決策:**
Firebaseルールに`demacia_rooms`セクションを追加（上記参照）

### 問題3: ルームIDが間違っている

**症状:**
どちらのルームにも参加できない

**原因:**
- ルームIDの入力ミス
- ルームが既に削除された

**解決策:**
1. ルームIDを再確認（6桁の数字）
2. ルーム作成者に再度URLを送ってもらう
3. 新しいルームを作成

### 問題4: キャッシュの問題

**症状:**
- 以前は動作していたが急に動かなくなった
- コンソールにエラーがない

**解決策:**
1. ハードリロード:
   - Windows/Linux: `Ctrl + Shift + R`
   - Mac: `Cmd + Shift + R`
2. キャッシュクリア:
   ```javascript
   // ブラウザコンソールで実行
   clearAppCache();
   location.reload();
   ```

## 📊 デバッグチェックリスト

ルーム作成者・参加者の両方で確認：

### 作成者側
- [ ] コンソールに「✅ ルーム作成成功」が表示される
- [ ] コンソールに「🔍 作成確認: 成功」が表示される
- [ ] 待機室画面に6桁のルームIDが表示される
- [ ] 右上に「接続中」と表示される

### 参加者側
- [ ] ルームIDを正しく入力した（6桁）
- [ ] プレイヤー名を入力した
- [ ] 右上に「接続中」と表示される
- [ ] コンソールに「ワードウルフルーム存在」または「デマーシアルーム存在」が`true`と表示される

## 🔧 高度なデバッグ

### Firebase Consoleで直接確認

1. [Firebase Console](https://console.firebase.google.com/) にアクセス
2. プロジェクト `lol-word-wolf` を選択
3. 「Realtime Database」を選択
4. 「データ」タブをクリック
5. 以下のパスを確認：
   - `rooms/` - ワードウルフのルーム一覧
   - `demacia_rooms/` - デマーシアのルーム一覧

### 手動でルームを確認
```javascript
// ブラウザコンソールで実行
const roomId = 'XXXXXX'; // ルームIDを入力

// ワードウルフルームを確認
firebase.database().ref(`rooms/${roomId}`).once('value').then(snap => {
  console.log('ワードウルフルーム:', snap.exists() ? snap.val() : '存在しない');
});

// デマーシアルームを確認
firebase.database().ref(`demacia_rooms/${roomId}`).once('value').then(snap => {
  console.log('デマーシアルーム:', snap.exists() ? snap.val() : '存在しない');
});
```

## 📞 サポート

上記の手順を試しても解決しない場合：

1. ブラウザのコンソールログをスクリーンショット
2. Firebaseセキュリティルールのスクリーンショット
3. エラーメッセージの詳細を記録
4. GitHub Issuesまたはお問い合わせフォームで報告

---

**これらの修正により、ルーム参加の問題が解決されます！** 🎉
