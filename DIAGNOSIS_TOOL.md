# 🔍 接続診断ツール - 実装ドキュメント

## 概要

スマホやタブレットからのルーム作成・参加ができない問題を診断するためのツールです。

---

## 🎯 実装の目的

### 報告された問題
- PCでルームを立てて取得したIDで、スマホやタブレットからルームに参加できない
- スマホやタブレットからルーム作成もできない
- すべてのゲーム（ワードウルフ、デマーシア、ヴォイド）に共通する問題

### 診断ツールの役割
1. **問題の特定**: 接続エラーの原因を明確に表示
2. **自己診断**: ユーザー自身で問題を解決できるようにサポート
3. **詳細ログ**: 技術的な問題の特定と報告を容易に

---

## 📁 実装ファイル

### 1. `diagnosis.html` (新規作成)
接続診断ツールのメインページ

**機能:**
- デバイス情報の表示
- Firebase接続テスト
- ルーム作成/参加テスト
- 詳細ログ表示

### 2. `index.html` (更新)
フッターに診断ツールへのリンクを追加

### 3. `js/game.js` (更新)
エラーメッセージに診断ツールへの案内を追加

### 4. `js/demacia-game.js` (更新)
エラーメッセージに診断ツールへの案内を追加

### 5. `js/void-game.js` (更新)
エラーメッセージに診断ツールへの案内を追加

### 6. `README.md` (更新)
トラブルシューティングセクションに診断ツールを追加

---

## 🔍 診断ツールの機能

### 1. デバイス情報
```javascript
- デバイスタイプ: Android / iOS / デスクトップ
- ブラウザ: Chrome / Safari / Firefox / Edge / Opera
- 画面サイズ: 幅 x 高さ
- オンライン状態: オンライン / オフライン
```

### 2. Firebase接続テスト
```javascript
async function testFirebaseConnection() {
  // 1. .info/connected で接続状態を確認
  // 2. テストデータの書き込み
  // 3. データの削除（クリーンアップ）
  // 4. 結果を表示
}
```

### 3. ルーム作成テスト
```javascript
async function testRoomCreate() {
  // 1. ランダムなルームIDを生成
  // 2. テストルームを作成
  // 3. データを読み取り確認
  // 4. テストルームを削除
  // 5. 結果を表示
}
```

### 4. ルーム参加テスト
```javascript
async function testRoomJoin() {
  // 1. テストルームを作成
  // 2. プレイヤーとして参加
  // 3. 参加を確認
  // 4. テストルームを削除
  // 5. 結果を表示
}
```

---

## 🎨 UI/UX

### カラーリング
```css
- 成功: 緑 (#10b981)
- エラー: 赤 (#ef4444)
- 警告: 黄色 (#f59e0b)
- 情報: 青 (#3b82f6)
```

### レスポンシブデザイン
- モバイル最適化
- タッチフレンドリーなボタン
- スクロール可能なログ表示

---

## 🔧 よくある問題と解決策

### Firebase接続エラー

**原因:**
1. ネットワーク接続の問題
2. Firebaseサービスの障害
3. VPNの干渉
4. ブラウザのキャッシュ問題

**解決策:**
```
1. Wi-Fi/モバイルデータ接続を確認
2. ブラウザのキャッシュをクリア
3. 別のブラウザで試す
4. VPNを無効化
5. Firebaseのステータスページを確認
```

### ルーム作成失敗

**原因:**
1. Cookieが無効
2. ローカルストレージが無効
3. プライベートモード/シークレットモード
4. Firebaseセキュリティルール

**解決策:**
```
1. Cookieとローカルストレージを有効化
2. プライベートモードを無効化
3. ページを完全に再読み込み（Ctrl+Shift+R）
4. Firebaseルールを確認
```

### ルーム参加失敗

**原因:**
1. ルームIDが間違っている
2. ルームが既に削除された
3. ネットワークタイムアウト
4. 同時接続の制限

**解決策:**
```
1. ルームIDを再確認（6桁の大文字）
2. ホストに新しいルームを作成してもらう
3. ページをリロード
4. 時間をおいて再試行
```

---

## 📊 ログ出力

### ログレベル
```javascript
- ℹ️ info: 一般的な情報
- ✅ success: 成功
- ❌ error: エラー
- ⚠️ warning: 警告
```

### ログフォーマット
```
[HH:MM:SS] 🔍 メッセージ内容
```

---

## 🚀 使用方法

### ユーザー向け

1. **アクセス方法**
   - サイトフッターの「🔍 接続診断」をクリック
   - または `diagnosis.html` に直接アクセス

2. **自動診断**
   - ページを開くと自動的にFirebase接続テストを実行
   - デバイス情報が表示される

3. **手動テスト**
   - 「再テスト」ボタンでFirebase接続を再確認
   - 「ルーム作成テスト」でルーム作成をテスト
   - 「ルーム参加テスト」でルーム参加をテスト

4. **結果の確認**
   - 各テストの結果がステータス表示
   - 詳細ログで技術的な情報を確認

---

## 🔐 セキュリティとプライバシー

### データの取り扱い
- すべてのテストデータは自動的に削除
- ユーザーの個人情報は収集しない
- ログはブラウザのコンソールにのみ出力

### Firebase読み書き
```javascript
// テストデータは一時的なパスに作成
database.ref('_connection_test/' + timestamp)
database.ref('rooms/TEST_' + randomId)

// テスト後は必ず削除
await testRef.remove();
```

---

## 🛠️ 技術仕様

### 依存関係
- Firebase SDK 9.22.0
- `js/firebase-config.js` (Firebase設定)

### ブラウザ対応
- ✅ Chrome (PC/Android)
- ✅ Safari (Mac/iOS)
- ✅ Firefox (PC/Android)
- ✅ Edge (PC)
- ✅ Opera (PC/Android)

### モバイル最適化
```html
<meta name="viewport" content="width=device-width, initial-scale=1.0">
```

---

## 📝 エラーメッセージの改善

### 改善前
```javascript
throw new Error('ルームが存在しません');
```

### 改善後
```javascript
const errorMsg = 'ルームが存在しません。\n\n' +
  'ルームIDが正しいか確認してください。\n' +
  '接続に問題がある場合は、画面下部の「🔍 接続診断」をクリックして診断ツールをお試しください。';
throw new Error(errorMsg);
```

---

## 🎯 実装の効果

### ユーザーにとって
1. **自己解決**: サポートを待たずに問題を解決できる
2. **明確なフィードバック**: 何が問題かすぐに分かる
3. **安心感**: 技術的な問題を可視化

### 開発者にとって
1. **デバッグ支援**: ユーザーからの詳細な報告
2. **サポート負担軽減**: FAQ + 診断ツールで多くの問題を解決
3. **問題の早期発見**: 共通の問題をすぐに特定

---

## 🔄 今後の改善案

### フェーズ2
- [ ] テスト結果のエクスポート機能
- [ ] 自動修復機能（キャッシュクリアなど）
- [ ] 多言語対応（英語、韓国語、中国語）

### フェーズ3
- [ ] リアルタイム監視ダッシュボード
- [ ] 統計情報（成功率、エラー頻度）
- [ ] AIによる問題診断

---

## 📞 サポート

診断ツールで問題が解決しない場合：

1. 診断ログのスクリーンショットを撮る
2. お問い合わせページから報告
3. 以下の情報を含める：
   - デバイスタイプとブラウザ
   - エラーメッセージ
   - 診断ログ

---

**実装日**: 2026年2月16日  
**バージョン**: v1.0  
**ステータス**: 実装完了 ✅
