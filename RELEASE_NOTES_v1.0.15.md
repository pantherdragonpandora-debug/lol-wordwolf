# 🎉 リリースノート v1.0.15

## 📅 リリース情報
- **バージョン:** v1.0.15
- **リリース日:** 2026-02-14
- **種別:** バグ修正（重要）

## 🎯 主な変更内容

### 🐛 バグ修正（重要）

#### デマーシア投票画面の誤表示を修正
**問題:** デマーシアモードの投票画面で、誤ってワードウルフの画面（「誰がウルフですか？」）が表示されていた

**修正内容:**
- ✅ ゲームモード判定ロジックを改善
- ✅ Firebaseデータ構造に `gameMode` フィールドを追加
- ✅ デマーシアで正しいシチュエーション選択画面が表示されるように修正
- ✅ 投票状況のリアルタイム表示を追加

**影響範囲:** デマーシア（LOL、VALORANT）すべてのモード

---

## 🆕 新機能

### 1. ゲームモード識別の強化

Firebaseルームデータに `gameMode` フィールドを追加：

**デマーシア:**
```javascript
{
  gameMode: 'demacia',
  gameState: 'voting',
  ...
}
```

**ワードウルフ:**
```javascript
{
  gameMode: 'wordwolf',
  gameState: 'voting',
  ...
}
```

これにより、`voting` 状態でも正しいゲームモードの画面を表示できるようになりました。

### 2. デマーシア投票状況のリアルタイム表示

投票画面に投票状況が表示されるようになりました：

```
2 / 4 人が投票完了
```

**機能詳細:**
- 演技者を除いた投票者数を表示
- リアルタイムで更新
- 全員投票完了で自動的に結果画面へ遷移

### 3. 投票済みユーザーのUI制御

**デマーシア投票後の動作:**
- ✅ 投票ボタンが「投票完了」に変化
- ✅ ボタンが無効化され、再投票不可
- ✅ 「✅ 投票完了！他のプレイヤーの投票を待っています...」メッセージ表示

---

## 🔧 技術的改善

### 画面遷移ロジックの改善

**Before (v1.0.14):**
```javascript
// 問題: voting状態で両方のゲームモードが混在
if (roomData.gameState === 'voting') {
  showVotingScreen(roomData);  // ワードウルフ
}
else if (roomData.gameState === 'voting') {
  showDemaciaVotingScreen();   // デマーシア（到達しない）
}
```

**After (v1.0.15):**
```javascript
// ゲームモードを判定
const isDemaciaMode = roomData.gameMode === 'demacia' || 
                      roomData.gameState === 'performer_selection' || 
                      roomData.gameState === 'performing' || 
                      roomData.gameState === 'round_result';

if (isDemaciaMode) {
  // デマーシアモードの画面遷移
  if (roomData.gameState === 'voting') {
    showDemaciaVotingScreen();
    checkDemaciaVotingComplete();
  }
} else {
  // ワードウルフモードの画面遷移
  if (roomData.gameState === 'voting') {
    showVotingScreen(roomData);
    checkWordWolfVotingComplete(roomData);
  }
}
```

---

## 📊 変更統計

### ファイル変更
| ファイル | 追加 | 削除 | 変更内容 |
|---------|-----|-----|---------|
| `js/main.js` | +105 | -60 | ゲームモード判定・投票画面強化 |
| `js/demacia-game.js` | +1 | 0 | gameMode追加 |
| `js/game.js` | +1 | 0 | gameMode追加 |
| `index.html` | +5 | 0 | 投票状況UI追加 |
| `js/version.js` | +1 | -1 | バージョン更新 |
| **合計** | **+113** | **-61** | **5ファイル** |

---

## 🧪 テスト項目

### 必須テスト（3人以上推奨）

#### デマーシア投票フロー
- [ ] 投票画面が正しく表示される（シチュエーション選択）
- [ ] 「演技者はどのシチュエーションを演じていましたか？」と表示
- [ ] 6つのシチュエーション選択肢が表示される
- [ ] 投票状況「X / Y 人が投票完了」が表示される
- [ ] 各プレイヤーが投票できる
- [ ] 投票後にボタンが無効化される
- [ ] 投票状況がリアルタイム更新される
- [ ] 全員投票完了時に自動で結果画面へ遷移
- [ ] 結果画面に各プレイヤーの投票結果が表示される

#### ワードウルフ投票フロー（回帰テスト）
- [ ] 投票画面が正しく表示される（プレイヤー選択）
- [ ] 「誰がウルフだと思いますか？」と表示
- [ ] プレイヤー選択肢が表示される
- [ ] 投票フローが正常に動作する

---

## 🔍 互換性

### ブラウザ対応
- ✅ Chrome / Edge (最新版)
- ✅ Firefox (最新版)
- ✅ Safari (最新版)
- ✅ モバイルブラウザ (iOS Safari, Chrome Mobile)

### 既存データへの影響
- ⚠️ **重要:** 古いルーム（v1.0.14以前）には `gameMode` フィールドがありません
- ✅ 新規ルーム作成時に `gameMode` が自動設定されます
- ✅ フォールバック判定により古いルームでも動作します
- 📝 **推奨:** v1.0.15以降は新しいルームを作成してください

### Firebase構造
- ✅ `gameMode` フィールド追加（'demacia' または 'wordwolf'）
- ✅ 既存のセキュリティルールで動作
- ✅ マイグレーション不要

---

## 📝 アップグレード手順

### 1. ブラウザキャッシュのクリア

**自動クリア:**
- ページアクセス時に自動的にキャッシュクリア
- 通知表示: `🎉 アップデート完了！ v1.0.15`

**手動クリア:**
```
Windows: Ctrl + Shift + R
Mac: Cmd + Shift + R
```

### 2. バージョン確認

```javascript
getAppVersion()  // "1.0.15" と表示されればOK
```

### 3. 動作確認

**推奨テスト:**
1. デマーシアで3人以上のゲームを作成
2. 演技フェーズから投票までプレイ
3. 投票画面が正しく表示されるか確認（シチュエーション選択）
4. 全員投票後に結果画面が表示されるか確認

---

## 🐛 既知の問題

### 古いルームでの動作

**問題:**
- v1.0.14以前に作成されたルームには `gameMode` フィールドがありません
- フォールバック判定により動作しますが、完全に保証されません

**対処法:**
- **新しいルームを作成してください**
- 古いルームは使用せず、v1.0.15以降で新規作成を推奨

---

## 🔜 次回アップデート予定

### v1.1.0（予定）
- 🎨 UI/UXの全面改善
- 📊 統計機能の追加（勝率、プレイ回数など）
- 🎮 カスタムゲームモード
- 🌐 より多くの言語サポート

---

## 💡 フィードバック

バグ報告や機能要望は以下の方法でお知らせください：
- GitHub Issues
- プロジェクトのREADME記載の連絡先

---

## 🙏 謝辞

このバージョンは、ユーザーの皆様からの「デマーシアの投票画面がワードウルフになっている」というフィードバックを基に修正を行いました。
詳細な報告をいただき、誠にありがとうございました。

---

## 📚 ドキュメント

### 新規ドキュメント
- `DEMACIA_VOTING_SCREEN_FIX_v1.0.15.md` - 今回の修正の詳細解説

### 更新ドキュメント
- `README.md` - バージョン情報の更新

### 既存ドキュメント
- `WORDWOLF_VOTING_FIX_v1.0.14.md` - ワードウルフ投票システム修正
- `DEMACIA_VOTING_SYSTEM.md` - デマーシア投票システム
- `TROUBLESHOOTING.md` - 一般的な問題

---

## 📞 サポート

問題が発生した場合：
1. `DEMACIA_VOTING_SCREEN_FIX_v1.0.15.md` のトラブルシューティングを確認
2. ブラウザのコンソールでエラーログを確認
3. 新しいルームを作成してテスト
4. 上記で解決しない場合はフィードバックをお送りください

---

**Happy Gaming! 🎮**

---

**変更履歴:**
- v1.0.15 (2026-02-14): デマーシア投票画面修正
- v1.0.14 (2026-02-14): ワードウルフ投票システム修正
- v1.0.13 (2026-02-14): デマーシアシチュエーション表示修正
- v1.0.12 (2026-02-14): デマーシア投票システム実装
